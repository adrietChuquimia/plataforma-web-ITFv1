<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../static/galeria/imagenes/vision-artificial.png" rel="icon">
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link href="../static/bootstrapC1/css/vision_comp.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <title>Visión computacional</title>
</head>

<body>
    <header>
        <div class="header-title">
            <i class="fas fa-brain"></i> VISIÓN DIGITAL
            <p class="subtitle">Reconocimiento de piezas automotrices</p>
        </div>
        <div class="header-buttons ">
            <a href="{{ url_for('main.menuest') }}" class="btn">
                <i class="fas fa-home"></i> Inicio
            </a>
            <a href="{{ url_for('auth.logout') }}" class="btn">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </a>
        </div>
    </header>

    <div class="container">
        <div class="features-grid">
            <!-- Cámara Feature -->
            <div class="feature-card">
                <h2 class="feature-title">Captura en Tiempo Real</h2>
                <p>Utiliza tu cámara para escanear piezas automotrices al instante</p>
                <video id="video" autoplay playsinline width="350" height="250"></video><br>
                <button id="capturar" class="btn">Escanear Pieza</button>
            </div>
            <!-- Upload Feature -->
            <div class="feature-card">
                <h2 class="feature-title">Carga de Archivos</h2>
                <p>Sube imágenes desde tu dispositivo para reconocer la pieza</p>
                <div class="file-input-container">
                    <input type="file" id="imageInput" class="file-input" accept="image/*">
                    <label for="imageInput" class="file-input-label">  Seleccionar aquí para subir una Imagen</label>
                </div>
                <button id="subirBtn" onclick="subirImagen()" class="btn"> Analizar Imagen</button>
            </div>
        </div>

        <!-- Canvas oculto -->
        <canvas id="canvas" style="display:none;"></canvas>

        <!-- Modal/Tarjeta flotante para resultados -->
        <div id="modalOverlay" class="modal-overlay">
            <div class="result-card">
                <div id="resultado"></div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const resultado = document.getElementById("resultado");
        const modalOverlay = document.getElementById("modalOverlay");
        const capturarBtn = document.getElementById("capturar");
        const subirBtn = document.getElementById("subirBtn");

        // Iniciar cámara
        navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'environment'
            }
        })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                console.error("Error con la cámara:", err);
                mostrarError("No se pudo acceder a la cámara. Verifica los permisos.");
            });

        // Capturar de la cámara
        capturarBtn.onclick = () => {
            if (video.videoWidth === 0) {
                mostrarError("La cámara no está lista. Espera un momento e intenta de nuevo.");
                return;
            }

            // Deshabilitar botones
            deshabilitarBotones();

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            let imgBase64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
            enviarImagen(imgBase64);
        };

        // Subir imagen desde dispositivo
        function subirImagen() {
            const input = document.getElementById("imageInput");
            const file = input.files[0];
            if (!file) {
                mostrarError("Por favor, selecciona una imagen primero.");
                return;
            }

            if (!file.type.startsWith('image/')) {
                mostrarError("Por favor, selecciona un archivo de imagen válido.");
                return;
            }

            // Deshabilitar botones
            deshabilitarBotones();

            const reader = new FileReader();
            reader.onload = function () {
                let base64Image = reader.result.split(",")[1];
                enviarImagen(base64Image);
            };
            reader.readAsDataURL(file);
        }

        function deshabilitarBotones() {
            capturarBtn.disabled = true;
            subirBtn.disabled = true;
        }

        function habilitarBotones() {
            capturarBtn.disabled = false;
            subirBtn.disabled = false;
        }

        // Enviar al backend
        function enviarImagen(base64Image) {
            mostrarCargando();

            fetch("/predict", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify({ imagen: base64Image })
            })
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`Error HTTP: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.error) {
                        mostrarError(data.error);
                    } else {
                        mostrarResultado(data);
                    }
                })
                .catch(error => {
                    console.error("Error de conexión:", error);
                    mostrarError("Error de conexión con el servidor. Verifica tu conexión a internet.");
                });
        }

        function mostrarCargando() {
            modalOverlay.classList.add('active');
            resultado.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text"> Analizando pieza automotriz...</div>
                </div>
            `;
        }

        function mostrarResultado(data) {
            resultado.innerHTML = `
                <div class="result-pieza">
                     ${data.pieza}
                </div>
                <div style="text-align: center;">
                    <div class="result-probabilidad">
                        ${data.probabilidad}% Precisión
                    </div>
                </div>
                <div class="result-info">
                    <div class="info-title">
                        Características Técnicas
                    </div>
                    <ul class="info-list">
                        ${data.informacion.map(info => `<li class="info-item">${info}</li>`).join("")}
                    </ul>
                </div>
                <button class="btn-accept" onclick="cerrarModal()">Continuar con otra pieza</button>
            `;
        }

        function mostrarError(mensaje) {
            modalOverlay.classList.add('active');
            resultado.innerHTML = `
                <div class="error">
                    <h3> Error en el Análisis</h3>
                    <p>${mensaje}</p>
                    <p><em>Intenta con una imagen más clara o verifica tu conexión.</em></p>
                    <button class="btn-accept" onclick="cerrarModal()" style="background: linear-gradient(45deg, #ff4444, #ff6666); margin-top: 20px;">
                        Intentar de Nuevo
                    </button>
                </div>
            `;
        }

        function cerrarModal() {
            modalOverlay.classList.remove('active');
            habilitarBotones();
        }

        // Cerrar modal al hacer clic fuera
        modalOverlay.addEventListener('click', function (e) {
            if (e.target === modalOverlay) {
                cerrarModal();
            }
        });

        // Actualizar label del input cuando se selecciona archivo
        document.getElementById('imageInput').addEventListener('change', function (e) {
            const label = document.querySelector('.file-input-label');
            if (e.target.files.length > 0) {
                label.textContent = ` ${e.target.files[0].name}`;
                label.style.background = 'linear-gradient(45deg, #00ff80, #00ffff)';
            } else {
                label.textContent = 'Seleccionar Imagen';
                label.style.background = 'linear-gradient(45deg, #ff00ff, #8000ff)';
            }
        });
    </script>
</body>

</html>