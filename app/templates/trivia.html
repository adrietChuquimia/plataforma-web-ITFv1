<!DOCTYPE html>
<html lang="es">
<head>
   <meta charset="utf-8">
   <meta content="width=device-width, initial-scale=1.0" name="viewport">
   <title>Trivia Automotriz</title>
   <meta content="" name="description">
   <meta content="" name="keywords">

   <link href="../static/galeria/imagenes/trivia.png" rel="icon">
   <link href="../static/bootstrapC1/bootstrap/css/bootstrap.min.css" rel="stylesheet">
   <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
   <link href="../static/bootstrapC1/css/trivia.css" rel="stylesheet">
</head>
<body>
   <header>
        <div class="header-title">
            <i class="fas fa-car"></i>TRIVIA AUTOMOTRIZ 
            <p class="subtitle">Responde las preguntas</p>
        </div>
        <div class="header-buttons">
            <a href="{{ url_for('main.menuest') }}" class="btn">
                <i class="fas fa-home"></i> Inicio
            </a>
            <a href="{{ url_for('auth.logout') }}" class="btn">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </a>
        </div>
    </header>
  
    <div class="main-container">
        <!-- Panel del Tutor Inteligente -->
        {% if session.get('ultimo_mensaje') %}
        <div class="tutor-panel" id="tutorPanel">
            <div class="tutor-icon">
                <i class="fas fa-robot"></i>
            </div>
            <div class="tutor-content">
                <div class="tutor-header">
                    <span class="tutor-label">
                        <i class="fas fa-brain"></i> Análisis del Tutor IA
                    </span>
                    <button class="close-tutor" onclick="closeTutor()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="tutor-message">
                    {{ session.get('ultimo_mensaje') }}
                </div>
                <div class="tutor-metrics">
                    <div class="metric">
                        <i class="fas fa-bullseye"></i>
                        <span>Precisión: {{ "%.1f"|format(precision) }}%</span>
                    </div>
                    <div class="metric">
                        <i class="fas fa-chart-line"></i>
                        <span>Racha: {{ session.get('racha', 0) }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Panel de Información Principal -->
        <div class="info-panel">
            <!-- Indicador de Nivel con Progreso -->
            <div class="level-indicator">
                <div class="level-badge level-{{nivel}}">
                    <i class="fas fa-trophy"></i> NIVEL {{nivel}}
                </div>
                
                {% set racha = session.get('racha', 0) %}
                {% if nivel == 1 %}
                    {% set necesarios = 5 %}
                {% elif nivel == 2 %}
                    {% set necesarios = 8 %}
                {% elif nivel == 3 %}
                    {% set necesarios = 12 %}
                {% elif nivel == 4 %}
                    {% set necesarios = 16 %}
                {% elif nivel == 5 %}
                    {% set necesarios = 0 %}
                {% endif %}
                
                {% if necesarios > 0 %}
                    {% set progreso = (racha / necesarios * 100) | int %}
                    <div class="level-progress-container">
                        <div class="level-progress-bar">
                            <div class="level-progress-fill" style="width: {{progreso}}%"></div>
                        </div>
                        <p class="progress-text">
                            <i class="fas fa-target"></i> 
                            Racha: {{racha}}/{{necesarios}} para siguiente nivel
                        </p>
                    </div>
                {% endif %}
            </div>

            <!-- Estadísticas del Jugador -->
            <div class="stats-container">
                <div class="stat-item stat-lives">
                    <div class="stat-label">
                        <i class="fas fa-heart"></i> Vidas
                    </div>
                    <div class="stat-value lives-value">{{vidas}}</div>
                </div>
                
                <div class="stat-item stat-points">
                    <div class="stat-label">
                        <i class="fas fa-star"></i> Puntos
                    </div>
                    <div class="stat-value points-value">{{puntos | round(1)}}</div>
                </div>
                
                <div class="stat-item stat-streak {% if racha >= 3 %}stat-highlight{% endif %}">
                    <div class="stat-label">
                        <i class="fas fa-fire"></i> Racha
                    </div>
                    <div class="stat-value streak-value">{{racha}}</div>
                    {% if racha >= 3 %}
                    <div class="streak-bonus">¡BONUS x{{(racha//3)|int}}!</div>
                    {% endif %}
                </div>
                
                <div class="stat-item stat-precision">
                    <div class="stat-label">
                        <i class="fas fa-bullseye"></i> Precisión
                    </div>
                    <div class="stat-value precision-value">{{ "%.0f"|format(precision) }}%</div>
                </div>
                
                <div class="stat-item stat-achievements">
                    <div class="stat-label">
                        <i class="fas fa-medal"></i> Logros
                    </div>
                    <div class="stat-value achievement-value">{{logros | length}}</div>
                </div>
            </div>


            <!-- Logros Desbloqueados -->
            {% if logros %}
            <div class="achievements-container">
                <p class="achievements-title">
                    <i class="fas fa-trophy"></i> Logros Desbloqueados
                </p>
                <div class="achievements-grid">
                    {% if '10_puntos' in logros %}
                    <div class="achievement-badge" title="Alcanzar 10 puntos">
                        <i class="fas fa-star"></i> <span class="badge-text">10 Puntos</span>
                    </div>
                    {% endif %}
                    {% if '25_puntos' in logros %}
                    <div class="achievement-badge" title="Alcanzar 25 puntos">
                        <i class="fas fa-gem"></i> <span class="badge-text">25 Puntos</span>
                    </div>
                    {% endif %}
                    {% if '50_puntos' in logros %}
                    <div class="achievement-badge" title="Alcanzar 50 puntos">
                        <i class="fas fa-crown"></i> <span class="badge-text">50 Puntos</span>
                    </div>
                    {% endif %}
                    {% if '100_puntos' in logros %}
                    <div class="achievement-badge" title="Alcanzar 100 puntos">
                        <i class="fas fa-trophy"></i> <span class="badge-text">100 Pts</span>
                    </div>
                    {% endif %}
                    {% if 'nivel_3' in logros %}
                    <div class="achievement-badge" title="Alcanzar nivel 3">
                        <i class="fas fa-level-up-alt"></i> <span class="badge-text">Nivel 3</span>
                    </div>
                    {% endif %}
                    {% if 'nivel_5' in logros %}
                    <div class="achievement-badge" title="Alcanzar nivel 5">
                        <i class="fas fa-trophy"></i> <span class="badge-text">Nivel 5</span>
                    </div>
                    {% endif %}
                    {% if 'racha_3' in logros %}
                    <div class="achievement-badge" title="3 aciertos seguidos">
                        <i class="fas fa-fire"></i> <span class="badge-text">Racha x3</span>
                    </div>
                    {% endif %}
                    {% if 'racha_5' in logros %}
                    <div class="achievement-badge" title="5 aciertos seguidos">
                        <i class="fas fa-fire-alt"></i> <span class="badge-text">Racha x5</span>
                    </div>
                    {% endif %}
                    {% if 'racha_10' in logros %}
                    <div class="achievement-badge" title="10 aciertos seguidos">
                        <i class="fas fa-meteor"></i> <span class="badge-text">Racha x10</span>
                    </div>
                    {% endif %}
                    {% if 'racha_15' in logros %}
                    <div class="achievement-badge" title="15 aciertos seguidos">
                        <i class="fas fa-rocket"></i> <span class="badge-text">Racha x15</span>
                    </div>
                    {% endif %}
                    {% if 'velocista' in logros %}
                    <div class="achievement-badge" title="Respuestas rápidas consistentes">
                        <i class="fas fa-bolt"></i> <span class="badge-text">Velocista</span>
                    </div>
                    {% endif %}
                    {% if 'perfeccion' in logros %}
                    <div class="achievement-badge" title="10 aciertos perfectos">
                        <i class="fas fa-certificate"></i> <span class="badge-text">Perfección</span>
                    </div>
                    {% endif %}
                    {% if 'precision_90' in logros %}
                    <div class="achievement-badge" title="90% de precisión">
                        <i class="fas fa-bullseye"></i> <span class="badge-text">Precisión 90%</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Pistas del Tutor -->
            {% if pregunta["pista"] %}
            <div class="hint-text">
                <i class="fas fa-lightbulb"></i> 
                <strong>Pregunta del Sistema:</strong><br>
                {{pregunta["pista"]}}
            </div>
            
            {% endif %}
            
        <!-- Formulario de Respuesta -->
        <form method="POST" id="triviaForm">
            {% if nivel == 1 %}
            <!-- NIVEL 1: Múltiple opción básico -->
            <div class="answers-container">
                {% for op in pregunta["opciones"] %}
                <button class="answer-btn" name="respuesta" value="{{op}}" type="submit">
                    <i class="fas fa-chevron-right"></i> {{op}}
                </button>
                {% endfor %}
            </div>

            {% elif nivel == 2 %}
            <!-- NIVEL 2: Múltiple opción con cronómetro -->
            <div class="timer-container">
                <div class="timer-circle">
                    <div class="timer-inner">
                        <div id="timer" class="timer-text" style="color: white;">{{ tiempo_limite }}</div>
                    </div>
                </div>
                <p class="timer-warning">
                    <i class="fas fa-exclamation-triangle"></i> ¡El tiempo corre!
                </p>
            </div>

            <div class="answers-container">
                {% for op in pregunta["opciones"] %}
                <button class="answer-btn" name="respuesta" value="{{op}}" type="submit">
                    <i class="fas fa-bolt"></i> {{op}}
                </button>
                {% endfor %}
            </div>

            <script>
                let timeLeft = {{ tiempo_limite }};
                const timer = document.getElementById("timer");
                const timerCircle = document.querySelector(".timer-circle");

                const countdown = setInterval(() => {
                    timeLeft--;
                    timer.textContent = timeLeft;

                    if (timeLeft <= 10) {
                        timerCircle.style.background = "conic-gradient(#ff0032 0deg, #ff0032 360deg)";
                        timer.style.color = "#ff0032";
                        timer.style.animation = "pulse-danger 0.5s infinite";
                    } else if (timeLeft <= 20) {
                        timerCircle.style.background = "conic-gradient(#ffff00 0deg, #ff6600 360deg)";
                        timer.style.color = "#ffff00";
                    }

                    if (timeLeft <= 0) {
                        clearInterval(countdown);
                        document.body.classList.add('error-flash');
                        setTimeout(() => {
                            alert("¡Tiempo agotado! -1 vida");
                            const form = document.forms[0];
                            const input = document.createElement("input");
                            input.type = "hidden";
                            input.name = "respuesta";
                            input.value = "tiempo_agotado";
                            form.appendChild(input);
                            form.submit();
                        }, 500);
                    }
                }, 1000);
            </script>

            {% elif nivel == 3 %}
            <!-- NIVEL 3: Entrada libre sin tiempo -->
            <div class="text-input-container">
                <input type="text" class="text-input" name="respuesta" 
                       placeholder="Escribe el nombre de la pieza..." 
                       autocomplete="off" required autofocus>
                <br>
                <button class="submit-btn" type="submit">
                    <i class="fas fa-paper-plane"></i> Enviar Respuesta
                </button>
            </div>

            {% elif nivel == 4 %}
            <!-- NIVEL 4: Modo mixto adaptativo -->          
            {% if pregunta["opciones"] %}
            <p class="tutor-decision">
                <i class="fas fa-info-circle"></i> 
                Sistema adaptativo: Opciones múltiples activadas
            </p>
            <div class="answers-container">
                {% for op in pregunta["opciones"] %}
                <button class="answer-btn" name="respuesta" value="{{op}}" type="submit">
                    <i class="fas fa-arrow-right"></i> {{op}}
                </button>
                {% endfor %}
            </div>
            {% else %}
            <p class="tutor-decision">
                <i class="fas fa-fire"></i> 
                Sistema adaptativo: Modo respuesta libre
            </p>
            <div class="text-input-container">
                <input type="text" class="text-input" name="respuesta" 
                       placeholder="Escribe el nombre de la pieza..." 
                       autocomplete="off" required autofocus>
                <br>
                <button class="submit-btn" type="submit">
                    <i class="fas fa-paper-plane"></i> Enviar Respuesta
                </button>
            </div>
            {% endif %}

            {% elif nivel == 5 %}
            <!-- NIVEL 5: Respuesta libre con tiempo -->
            <div class="timer-container">
                <div class="timer-circle master-timer">
                    <div class="timer-inner">
                        <div id="timer" class="timer-text" style="color: white;">{{ tiempo_limite }}</div>
                    </div>
                </div>
                <p class="timer-warning master-warning">
                    <i class="fas fa-bolt"></i> ¡Tiempo limitado para expertos!
                </p>
            </div>
            
            <div class="text-input-container">
                <input type="text" class="text-input master-input" name="respuesta" 
                       id="masterInput"
                       placeholder="Nombre del componente..." 
                       autocomplete="off" required autofocus>
                <br>
                <button class="submit-btn master-btn" type="submit">
                    <i class="fas fa-trophy"></i> Enviar Respuesta Maestra
                </button>
            </div>

            <script>
                let timeLeft = {{ tiempo_limite }};
                const timer = document.getElementById("timer");
                const timerCircle = document.querySelector(".timer-circle");
                const masterInput = document.getElementById("masterInput");

                const countdown = setInterval(() => {
                    timeLeft--;
                    timer.textContent = timeLeft;

                    if (timeLeft <= 5) {
                        timerCircle.style.background = "conic-gradient(#ff0032 0deg, #ff0032 360deg)";
                        timer.style.color = "#ff0032";
                        timer.style.animation = "pulse-danger 0.3s infinite";
                        masterInput.style.borderColor = "#ff0032";
                        masterInput.style.boxShadow = "0 0 30px rgba(255, 0, 50, 0.6)";
                    } else if (timeLeft <= 10) {
                        timerCircle.style.background = "conic-gradient(#ffff00 0deg, #ff6600 360deg)";
                        timer.style.color = "#ffff00";
                        masterInput.style.borderColor = "#ffff00";
                    }

                    if (timeLeft <= 0) {
                        clearInterval(countdown);
                        masterInput.disabled = true;
                        document.body.classList.add('error-flash');
                        setTimeout(() => {
                            alert("¡Tiempo agotado en nivel maestro! -2 vidas");
                            const form = document.forms[0];
                            const input = document.createElement("input");
                            input.type = "hidden";
                            input.name = "respuesta";
                            input.value = "tiempo_agotado_maestro";
                            form.appendChild(input);
                            form.submit();
                        }, 500);
                    }
                }, 1000);

                masterInput.addEventListener('input', function() {
                    if (this.value.length > 0) {
                        this.style.borderColor = "#ffd700";
                        this.style.boxShadow = "0 0 25px rgba(255, 215, 0, 0.5)";
                    }
                });
            </script>
            {% endif %}
            
            <input type="hidden" name="correcta" value="{{pregunta['pieza']}}">
        </form>
    </div>

    <!-- Indicador de Presión Visual -->
    <div class="pressure-indicator"></div>

    <script>
        function closeTutor() {
            const panel = document.getElementById('tutorPanel');
            if(panel) {
                panel.style.animation = 'slideOutUp 0.5s ease-out';
                setTimeout(() => panel.style.display = 'none', 500);
            }
        }

        const form = document.getElementById('triviaForm');
        const buttons = document.querySelectorAll('.answer-btn');

        buttons.forEach(button => {
            button.addEventListener('click', function(e) {
                this.style.transform = 'translateY(-2px) scale(0.98)';
                setTimeout(() => this.style.transform = '', 150);
            });

            button.addEventListener('mouseenter', function() {
                this.style.filter = 'brightness(1.2) saturate(1.3)';
            });

            button.addEventListener('mouseleave', function() {
                this.style.filter = '';
            });
        });

        const textInput = document.querySelector('.text-input');
        if (textInput) {
            textInput.focus();
        }

        const tutorPanel = document.getElementById('tutorPanel');
        if (tutorPanel) {
            setTimeout(() => tutorPanel.classList.add('show'), 100);
        }

        const achievements = document.querySelectorAll('.achievement-badge');
        achievements.forEach((badge, index) => {
            setTimeout(() => {
                badge.style.animation = 'bounceIn 0.6s ease';
            }, index * 100);
        });

        const streakValue = document.querySelector('.streak-value');
        if (streakValue && parseInt(streakValue.textContent) >= 3) {
            streakValue.style.animation = 'pulse-fire 1s infinite';
        }

        const precisionValue = document.querySelector('.precision-value');
        if (precisionValue) {
            const precision = parseFloat(precisionValue.textContent);
            if (precision >= 90) {
                precisionValue.style.color = '#00ff88';
                precisionValue.style.textShadow = '0 0 15px #00ff88';
            } else if (precision >= 70) {
                precisionValue.style.color = '#ffd700';
            } else if (precision < 50) {
                precisionValue.style.color = '#ff0032';
            }
        }
    </script>
</body>
</html>